<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>โปรแกรมช่วยสอน: ปิ้งหมึกหรรษา V2.1</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Mitr:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --squid-size: 210px;
            --number-font-size: 2.8em;
            --number-margin-top: 110px;
            --squid-color-filter: none;
        }

        /* --- General Styles --- */
        html, body {
            height: 100%; width: 100%; margin: 0; padding: 0;
            overflow: hidden; font-family: 'Mitr', sans-serif; background-color: #000;
            user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
        }
        
        #game-container {
            display: flex; flex-direction: column; justify-content: space-between;
            height: 100%; width: 100%; padding: 15px; box-sizing: border-box;
            background-image: url('BG.gif'); 
            background-size: cover; background-position: center;
            color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.6); visibility: hidden;
            position: relative;
        }

        /* --- Loading & Overlays --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #1a1a1a; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 200; color: white;
        }
        .spinner {
            width: 60px; height: 60px; border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%; border-top-color: #ffc107;
            animation: spin 1s ease-in-out infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .screen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); display: none;
            flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; color: white; text-align: center; padding: 15px;
            box-sizing: border-box;
        }
        .screen-overlay.active { display: flex; }
        
        .overlay-content { background-color: rgba(44, 62, 80, 0.9); border: 2px solid #3498db; padding: 20px 30px; border-radius: 20px; max-width: 600px; width: 90%; box-sizing: border-box;}
        .overlay-title { font-size: 2.5em; color: #ffc107; margin-bottom: 20px;}
        .overlay-text { font-size: 1.2em; line-height: 1.6; text-align: left; }
        .btn-back { background-color: #7f8c8d; color: white; margin-top: 20px;}
        
        /* --- Countdown Display --- */
        #countdown-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20em;
            font-weight: 700;
            color: #3498db;
            z-index: 150;
            display: none;
            text-shadow: 4px 4px 0px rgba(255, 255, 255, 0.8);
            animation-duration: 1s;
            animation-fill-mode: forwards;
        }
        
        .countdown-pop {
             animation-name: countdown-pop-animation;
        }

        @keyframes countdown-pop-animation {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            80% {
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                 opacity: 0;
            }
        }


        /* --- Buttons & Controls --- */
        .control-btn-group { position: absolute; top: 20px; right: 20px; z-index: 110; display: flex; gap: 10px; }
        .control-btn { width: 40px; height: 40px; background: rgba(0,0,0,0.4); border: 2px solid white; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.1s ease-out; }
        .control-btn:hover { transform: scale(1.1); } .control-btn:active { transform: scale(0.95); }
        #home-btn { left: 20px; right: auto; display: none; }
        .control-btn svg { width: 20px; height: 20px; fill: white; }
        #mute-btn .unmuted-icon, #mute-btn.muted .muted-icon { display: block; } #mute-btn.muted .unmuted-icon, #mute-btn .muted-icon { display: none; }
        #fullscreen-btn .fs-enter-icon, #fullscreen-btn.fs-exit .fs-exit-icon { display: block; } #fullscreen-btn.fs-exit .fs-enter-icon, #fullscreen-btn .fs-exit-icon { display: none; }

        .selection-group { display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%; }
        .selection-group button, .action-button { font-family: 'Mitr', sans-serif; font-size: 1.3em; padding: 12px 30px; border-radius: 15px; border: none; cursor: pointer; transition: transform 0.2s; width: 280px; max-width: 90%; }
        .selection-group button:hover, .action-button:hover { transform: scale(1.05); } .selection-group button:active, .action-button:active { transform: scale(0.98); }
        .btn-green { background-color: #27ae60; color: white; }
        .btn-blue { background-color: #2980b9; color: white; }
        .btn-orange { background-color: #d35400; color: white; }

        /* --- Game Elements --- */
        header { text-align: center; position: relative; }
        #player-stats { position: absolute; top: 0; left: 15px; font-size: 1.2em; text-align: left; }
        h1 { color: #ffc107; margin: 0; padding: 0; font-size: 1.8em; }
        #info-bar { display: flex; justify-content: space-around; width: 100%; font-size: 1.2em; flex-wrap: wrap; }
        
        main#squid-area { flex-grow: 1; min-height: 200px; position: relative; width: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .squid {
            width: var(--squid-size); height: calc(var(--squid-size) * 1.5);
            background-image: url('squid-1.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            cursor: grab; display: flex; justify-content: center; align-items: flex-start;
            transition: opacity 0.3s, transform 0.3s; touch-action: none; will-change: transform, opacity;
            filter: var(--squid-color-filter);
            position: relative;
        }
        .squid-absolute { position: absolute; }
        .number-display { background-color: rgba(255, 255, 255, 0.9); color: #c0392b; text-shadow: none; font-size: var(--number-font-size); font-weight: 600; padding: 5px 15px; border-radius: 20px; border: 3px solid #c0392b; margin-top: var(--number-margin-top); }
        
        footer { text-align: center; }
        #feedback { font-size: 1.3em; font-weight: bold; min-height: 50px; display: flex; align-items: center; justify-content: center; padding: 0 10px; }
        #grill-section { display: flex; justify-content: space-evenly; align-items: center; gap: 20px; padding-bottom: 10px; }
        .grill { border: 3px dashed transparent; border-radius: 15px; transition: all 0.3s ease-in-out; background-size: contain; background-position: center; background-repeat: no-repeat; width: 30vw; max-width: 220px; height: 30vw; max-height: 220px; position: relative; display: flex; justify-content: center; align-items: center; }
        .grill-label { position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); font-size: 1.2em; width: 100%; }
        #grill-1 { background-image: url('grill-1.png'); } #grill-2 { background-image: url('grill-2.png'); }

        /* --- Animations & Effects --- */
        .score-pop { animation: pop 0.3s ease-out; } @keyframes pop { 50% { transform: scale(1.3); } }
        .spawn-anim { animation: spawn 0.4s ease-out; } @keyframes spawn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        .drag-over { background-color: rgba(163, 228, 215, 0.5); border-style: solid; border-color: rgba(255,255,255,0.7); }
        .dragging { cursor: grabbing; opacity: 0.7; transform: scale(1.1) rotate(5deg); z-index: 50; }
        
        .squid-correct {
            position: absolute !important;
            transform: none !important;
            animation: grill-and-cook 2s forwards;
            animation-timing-function: linear;
        }
        @keyframes grill-and-cook {
            0% {
                opacity: 1;
                filter: var(--squid-color-filter) sepia(40%) saturate(2);
            }
            25% {
                filter: var(--squid-color-filter) sepia(80%) saturate(3) brightness(0.9);
            }
            50% {
                opacity: 1;
                filter: var(--squid-color-filter) sepia(100%) saturate(4) blur(1px) brightness(0.8);
            }
            100% {
                opacity: 0;
                filter: var(--squid-color-filter) sepia(100%) saturate(4) blur(1px) brightness(0.8);
            }
        }

        .squid-wrong { animation: shake-it 0.5s forwards; } 
        @keyframes shake-it {
            0% { transform: translateX(0); opacity: 1; } 
            20% { transform: translateX(-15px) rotate(-5deg); } 
            40% { transform: translateX(15px) rotate(5deg); } 
            60% { transform: translateX(-10px) rotate(-3deg); } 
            80% { transform: translateX(10px) rotate(3deg); }
            100% { transform: translateX(0); opacity: 0; }
        }
        
        .squid-rise {
            transform: translateX(-50%);
            animation-name: squid-rise-animation;
            animation-timing-function: linear;
            animation-fill-mode: forwards;
        }
        @keyframes squid-rise-animation {
            from { bottom: -315px; }
            to { bottom: 100%; }
        }

        /* --- Combo System --- */
        #combo-display { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 5em; font-weight: bold; color: #ffc107; z-index: 55; pointer-events: none; opacity: 0; animation: combo-pop 0.8s ease-out; text-shadow: 3px 3px 0 #c0392b; }
        @keyframes combo-pop { 0% { opacity: 1; transform: translate(-50%, -50%) scale(0.5); } 80% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); } 100% { opacity: 0; transform: translate(-50%, -50%) scale(1.1); } }

        /* --- Items (Powerups/Obstacles) --- */
        .game-item {
            position: absolute;
            width: calc(var(--squid-size) * 0.7);
            height: calc(var(--squid-size) * 0.7);
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            z-index: 60;
            animation: item-fall 5s linear forwards;
        }
        .item-timer { background-image: url('time.png'); }
        .item-bomb { background-image: url('bomb.png'); }
        @keyframes item-fall { from { transform: translateY(-100%); } to { transform: translateY(calc(100vh - 100px)); } }
        .item-clicked { animation: item-pop 0.4s ease-out forwards; }
        @keyframes item-pop { from { transform: scale(1); opacity: 1; } to { transform: scale(1.5); opacity: 0; } }

        /* --- Achievement System --- */
        #achievement-popup { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #27ae60; color: white; padding: 15px 25px; border-radius: 15px; z-index: 210; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.4); animation: slide-in-out 4s ease-in-out; }
        #achievement-popup-title { font-weight: bold; font-size: 1.2em; }
        @keyframes slide-in-out { 0% { bottom: -100px; opacity: 0; } 15% { bottom: 20px; opacity: 1; } 85% { bottom: 20px; opacity: 1; } 100% { bottom: -100px; opacity: 0; } }
        #achievement-list { list-style: none; padding: 0; max-height: 60vh; overflow-y: auto; width: 100%; }
        .achievement-item { background: rgba(0,0,0,0.2); margin-bottom: 10px; padding: 10px; border-radius: 8px; border-left: 5px solid #7f8c8d; }
        .achievement-item.unlocked { border-left-color: #27ae60; }
        .achievement-item h4 { margin: 0 0 5px 0; color: #f1c40f; }
        .achievement-item p { margin: 0; opacity: 0.8; }
        .achievement-item.unlocked h4 { color: #2ecc71; }

        /* --- Shop System --- */
        #shop-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 10px; max-height: 60vh; overflow-y: auto; }
        .shop-item { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; cursor: pointer; border: 2px solid #3498db; text-align: center; }
        .shop-item:hover { background: rgba(0,0,0,0.4); }
        .shop-item.owned { border-color: #7f8c8d; background: rgba(0,0,0,0.5); cursor: default; }
        .shop-item.equipped { border-color: #2ecc71; box-shadow: 0 0 10px #2ecc71; }
        .shop-item .item-preview {
            width: 80px; height: 80px; margin: 0 auto 10px auto;
            background-image: url('squid-1.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
        }
        .shop-item .item-price { font-weight: bold; color: #ffeb3b; }

        /* Responsive */
        @media (max-width: 768px) {
            h1, .overlay-title { font-size: 1.8em; }
            #info-bar, .overlay-text { font-size: 1em; }
            #countdown-display {
                font-size: 15em;
            }
        }
        @media (max-width: 480px) {
            :root { --squid-size: 160px; --number-margin-top: 80px; }
             #countdown-display {
                font-size: 10em;
            }
        }

    </style>
</head>
<body>
    <div id="loading-screen"><div class="spinner"></div><p>กำลังโหลด...</p></div>

    <div id="game-container">
        <div id="countdown-display"></div>
        
        <div id="combo-display"></div>
        <div id="achievement-popup"><h4 id="achievement-popup-title"></h4><p id="achievement-popup-desc"></p></div>

        <div class="control-btn-group">
            <button id="home-btn" class="control-btn" title="กลับหน้าหลัก"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg></button>
            <button id="mute-btn" class="control-btn" title="ปิด/เปิดเสียง"><svg class="unmuted-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg><svg class="muted-icon" style="display: none;" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"></path></svg></button>
            <button id="fullscreen-btn" class="control-btn" title="โหมดเต็มหน้าจอ"><svg class="fs-enter-icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"></path></svg><svg class="fs-exit-icon" style="display: none;" viewBox="0 0 24 24"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"></path></svg></button>
        </div>

        <div id="welcome-credit-screen" class="screen-overlay active">
            <div class="overlay-content" style="text-align: center; border: none; background: transparent;">
                <h2 class="overlay-title">โปรแกรมช่วยสอน: ปิ้งหมึกหรรษา</h2>
                <p style="font-size: 1.2em; margin-top: 40px;">จัดทำโดย</p>
                <h3 style="font-size: 1.8em; color: #ffeb3b; margin: 10px 0;">นางสาวกฤษณา แกล้วกล้า</h3>
                <p style="font-size: 1.2em;">ครูผู้ช่วย โรงเรียนสวนป่าอุปถัมภ์</p>
                <p style="margin-top: 50px; color: #ccc;">กำลังเข้าสู่เกมในอีกสักครู่...</p>
            </div>
        </div>
        <div id="register-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 class="overlay-title">ลงทะเบียน</h2>
                <div class="selection-group">
                    <p style="font-size: 1.1em; margin-bottom: 15px;">กรุณาใส่ชื่อของคุณเพื่อเริ่มเล่น</p>
                    <input type="text" id="player-name-input" placeholder="ใส่ชื่อที่นี่..." style="font-family: 'Mitr', sans-serif; font-size: 1.2em; padding: 10px; border-radius: 10px; border: 2px solid #3498db; width: 280px; max-width: 80%; text-align: center;">
                    <button id="btn-start-register" class="action-button btn-green" style="margin-top: 15px;">เริ่มเล่น</button>
                </div>
            </div>
        </div>
        <div id="main-menu-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 id="main-menu-title" class="overlay-title">ปิ้งหมึกหรรษา</h2>
                <div id="player-stats-menu" style="margin-bottom: 20px; font-size: 1.2em;"></div>
                <div class="selection-group">
                    <button id="btn-lesson-mode" class="btn-green">โหมดบทเรียน</button>
                    <button id="btn-endless" class="btn-blue">โหมดฝึกฝน (ปกติ)</button>
                    <button id="btn-challenge" class="btn-orange">โหมดฝึกฝน (ท้าทาย)</button>
                    <button id="btn-shop" style="background-color: #8e44ad; color: white;">ร้านค้า</button>
                    <button id="btn-achievements" style="background-color: #f39c12; color: white;">รางวัล</button>
                </div>
            </div>
        </div>
        <div id="lesson-select-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 id="lesson-select-title" class="overlay-title">เลือกบทเรียน</h2>
                <ul id="lesson-list"></ul>
                <button id="lesson-select-back-btn" class="action-button btn-back">กลับเมนูหลัก</button>
            </div>
        </div>
        <div id="difficulty-selection-screen" class="screen-overlay">
             <div class="overlay-content">
                <h2 id="difficulty-select-title" class="overlay-title">เลือกระดับความยาก</h2>
                <div id="difficulty-selection" class="selection-group">
                    <button id="btn-easy" class="btn-green">ง่าย</button>
                    <button id="btn-medium" style="background-color:#f1c40f; color:white;">ปานกลาง</button>
                    <button id="btn-hard" style="background-color:#c0392b; color:white;">ยาก</button>
                </div>
                 <button id="difficulty-select-back-btn" class="action-button btn-back">กลับเมนูหลัก</button>
            </div>
        </div>
        <div id="tutorial-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 id="tutorial-title" class="overlay-title"></h2>
                <div id="tutorial-body" class="overlay-text"></div>
                <button id="start-lesson-btn" class="action-button btn-green">เข้าใจแล้ว เริ่มเลย!</button>
            </div>
        </div>
        <div id="lesson-complete-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 id="summary-title" class="overlay-title"></h2>
                <p id="summary-accuracy" class="overlay-text"></p>
                <div id="summary-stars" class="summary-stars"></div>
                <p id="summary-feedback" class="overlay-text"></p>
                <div class="selection-group" id="summary-buttons">
                    <button id="retry-lesson-btn" class="action-button">ลองอีกครั้ง</button>
                    <button id="next-lesson-btn" class="action-button btn-green">บทเรียนถัดไป</button>
                    <button id="back-to-lessons-btn" class="action-button">กลับไปหน้าเลือกบทเรียน</button>
                </div>
            </div>
        </div>
        <div id="leaderboard-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 id="leaderboard-title">คะแนนสูงสุด</h2>
                <ul id="leaderboard-list"></ul>
                <button id="leaderboard-back-btn" class="action-button btn-green">กลับสู่เมนูหลัก</button>
            </div>
        </div>
        <div id="shop-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 class="overlay-title">ร้านค้า</h2>
                <div id="shop-list"></div>
                <button id="shop-back-btn" class="action-button btn-back">กลับเมนูหลัก</button>
            </div>
        </div>
        <div id="achievements-screen" class="screen-overlay">
            <div class="overlay-content">
                <h2 class="overlay-title">รางวัลความสำเร็จ</h2>
                <ul id="achievement-list"></ul>
                <button id="achievements-back-btn" class="action-button btn-back">กลับเมนูหลัก</button>
            </div>
        </div>

        <header>
            <div id="player-stats"></div>
            <h1></h1>
            <div id="info-bar"></div>
        </header>
        <main id="squid-area"></main>
        <footer>
            <div id="feedback"></div>
            <div id="grill-section">
                <div id="grill-1" class="grill"><span class="grill-label"></span></div>
                <div id="grill-2" class="grill"><span class="grill-label"></span></div>
            </div>
        </footer>
    </div>
    
    <audio id="sfx-correct" src="sound/correct.mp3" preload="auto"></audio>
    <audio id="sfx-wrong" src="sound/wrong.mp3" preload="auto"></audio>
    <audio id="sfx-combo" src="sound/combo.mp3" preload="auto"></audio>
    <audio id="sfx-countdown" src="sound/321.mp3" preload="auto"></audio>
    <audio id="sfx-levelup" src="sound/levelup.mp3" preload="auto"></audio>
    <audio id="sfx-achievement" src="sound/achievement.mp3" preload="auto"></audio>
    <audio id="sfx-powerup" src="sound/powerup.mp3" preload="auto"></audio>
    <audio id="sfx-bomb" src="sound/bomb.mp3" preload="auto"></audio>
    <audio id="sfx-end" src="sound/end.mp3" preload="auto"></audio>
    <audio id="bgm" src="sound/background.mp3" loop preload="auto"></audio>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CONFIG = {
            lessons: [
                { id: 'L01', title: 'บทที่ 1: เลขคู่-คี่ (1 หลัก)', questionsTotal: 10, passThreshold: 8, grillLabels: { one: ' ', two: ' ' }, tutorialHTML: `<h5 style="color: #5dade2; text-align: center;">🔵 จำนวนคู่ คืออะไร?</h5><p>จำนวนคู่ คือ จำนวนที่สามารถแบ่งเป็น 2 ส่วนเท่า ๆ กันได้พอดี โดยไม่เหลือเศษเลย</p><p><strong>🟢 ลองนึกภาพดูสิ...</strong></p><p style="margin: 5px 0;">ถ้ามีลูกอม 4 เม็ด แล้วเราแบ่งให้เพื่อน 2 คน คนละเท่า ๆ กัน เพื่อนแต่ละคนจะได้ 2 เม็ด ไม่มีเหลือเลย!</p><hr><h5 style="color: #f1c40f; text-align: center;">🔴 จำนวนคี่ คืออะไร?</h5><p>จำนวนคี่ คือ จำนวนที่เมื่อแบ่งเป็น 2 ส่วนเท่า ๆ กัน จะเหลือ 1 เสมอ</p><p><strong>🟡 ลองนึกภาพอีกที...</strong></p><p style="margin: 5px 0;">ถ้ามีลูกอม 5 เม็ด แล้วจะแบ่งให้เพื่อน 2 คน คนละเท่า ๆ กัน จะได้ไปคนละ 2 เม็ด... แล้วจะเหลือลูกอม 1 เม็ด!</p><hr><div style="background-color: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; margin-top: 15px;"><h5 style="margin-top:0; text-align: center;">✋ วิธีจำง่าย ๆ</h5><p style="margin-bottom: 5px;"><strong>จำนวนคู่</strong> คือจำนวนที่ลงท้ายด้วย <strong>0, 2, 4, 6, 8</strong></p><p style="margin-bottom: 0;"><strong>จำนวนคี่</strong> คือจำนวนที่ลงท้ายด้วย <strong>1, 3, 5, 7, 9</strong></p></div>`, problemGenerator: () => Math.floor(Math.random() * 10), getExplanation: (num, isCorrect) => { const type = num % 2 === 0 ? 'เลขคู่' : 'เลขคี่'; return `<strong>${num}</strong> เป็น <strong>${type}</strong>` + (isCorrect ? ' ถูกต้อง!' : ' นะ'); } },
                { id: 'L02', title: 'บทที่ 2: เลขคู่-คี่ (2 หลัก)', questionsTotal: 10, passThreshold: 8, grillLabels: { one: 'เลขคู่', two: 'เลขคี่' }, tutorialHTML: `<p>เก่งมาก! ต่อไปเรามาลองกับเลข 2 หลักกัน</p><p>จำไว้ว่า... เราดูแค่ <strong>เลขตัวสุดท้าย</strong> เท่านั้น!</p>`, problemGenerator: () => Math.floor(Math.random() * 90) + 10, getExplanation: (num, isCorrect) => { const type = num % 2 === 0 ? 'เลขคู่' : 'เลขคี่'; const lastDigit = num % 10; return `<strong>${num}</strong> เป็น <strong>${type}</strong> เพราะลงท้ายด้วยเลข <strong>${lastDigit}</strong>` + (isCorrect ? ' ถูกต้อง!' : ' นะ'); } },
                { id: 'L03', title: 'บทที่ 3: เลขคู่-คี่ (3 หลัก)', questionsTotal: 10, passThreshold: 9, grillLabels: { one: 'เลขคู่', two: 'เลขคี่' }, tutorialHTML: `<p>ด่านสุดท้ายแล้ว! เลขจะเยอะขึ้น แต่หลักการยังเหมือนเดิม</p><p>ไม่ต้องกลัวนะ... ดูแค่ <strong>เลขตัวสุดท้าย</strong> ก็พอ!</p>`, problemGenerator: () => Math.floor(Math.random() * 900) + 100, getExplanation: (num, isCorrect) => { const type = num % 2 === 0 ? 'เลขคู่' : 'เลขคี่'; const lastDigit = num % 10; return `<strong>${num}</strong> เป็น <strong>${type}</strong> เพราะลงท้ายด้วยเลข <strong>${lastDigit}</strong>` + (isCorrect ? ' ถูกต้อง!' : ' นะ'); } }
            ],
            practice: {
                endless: { title: "โหมดปกติ", initialTime: 60, levelUpScore: 10, timeBonus: 5 },
                challenge: { title: "โหมดท้าทาย", duration: 60, numLanes: 4, horizontalMargin: 10, difficulties: { easy: { name: "ง่าย", minSpawn: 1800, maxSpawn: 2500, minSpeed: 8, maxSpeed: 12 }, medium: { name: "ปานกลาง", minSpawn: 1200, maxSpawn: 2000, minSpeed: 6, maxSpeed: 9 }, hard: { name: "ยาก", minSpawn: 800, maxSpawn: 1500, minSpeed: 5, maxSpeed: 7.5 } } }
            },
            achievements: [
                { id: 'ach_lesson1_passed', title: 'บัณฑิตน้อย', description: 'ผ่านบทเรียนที่ 1 สำเร็จ' },
                { id: 'ach_score_50_endless', title: 'นักปิ้งมือฉมัง', description: 'ทำคะแนนโหมดปกติถึง 50 คะแนน' },
                { id: 'ach_combo_5', title: 'มือไวใจเร็ว', description: 'ทำคอมโบติดต่อกัน 5 ครั้ง' },
                { id: 'ach_shop_first_buy', title: 'นักช็อปหน้าใหม่', description: 'ซื้อของในร้านค้าครั้งแรก' }
            ],
            shop: {
                colors: [
                    { id: 'color_default', name: 'สีดั้งเดิม', price: 0, filter: 'none' },
                    { id: 'color_blue', name: 'หมึกสีฟ้า', price: 100, filter: 'sepia(1) saturate(5) hue-rotate(180deg) brightness(0.9)' },
                    { id: 'color_green', name: 'หมึกสีเขียว', price: 100, filter: 'sepia(1) saturate(5) hue-rotate(60deg) brightness(0.9)' },
                    { id: 'color_gold', name: 'หมึกทองคำ', price: 500, filter: 'grayscale(1) contrast(3) brightness(1.5) sepia(1) hue-rotate(-50deg) saturate(5)' },
                ]
            },
            comboThreshold: 3,
            comboBonusScore: 2,
            itemSpawnInterval: 8000,
            itemFallDuration: 5000,
        };

        const dom = { gameContainer: document.getElementById('game-container'), squidArea: document.getElementById('squid-area'), feedback: document.getElementById('feedback'), grill1: document.getElementById('grill-1'), grill2: document.getElementById('grill-2'), grill1Label: document.querySelector('#grill-1 .grill-label'), grill2Label: document.querySelector('#grill-2 .grill-label'), welcomeCreditScreen: document.getElementById('welcome-credit-screen'), registerScreen: document.getElementById('register-screen'), playerNameInput: document.getElementById('player-name-input'), btnStartRegister: document.getElementById('btn-start-register'), mainMenuScreen: document.getElementById('main-menu-screen'), mainMenuTitle: document.getElementById('main-menu-title'), lessonSelectScreen: document.getElementById('lesson-select-screen'), lessonSelectTitle: document.getElementById('lesson-select-title'), lessonList: document.getElementById('lesson-list'), lessonSelectBackBtn: document.getElementById('lesson-select-back-btn'), difficultySelectionScreen: document.getElementById('difficulty-selection-screen'), difficultySelectTitle: document.getElementById('difficulty-select-title'), btnEasy: document.getElementById('btn-easy'), btnMedium: document.getElementById('btn-medium'), btnHard: document.getElementById('btn-hard'), difficultySelectBackBtn: document.getElementById('difficulty-select-back-btn'), tutorialScreen: document.getElementById('tutorial-screen'), tutorialTitle: document.getElementById('tutorial-title'), tutorialBody: document.getElementById('tutorial-body'), startLessonBtn: document.getElementById('start-lesson-btn'), lessonCompleteScreen: document.getElementById('lesson-complete-screen'), summaryTitle: document.getElementById('summary-title'), summaryAccuracy: document.getElementById('summary-accuracy'), summaryStars: document.getElementById('summary-stars'), summaryFeedback: document.getElementById('summary-feedback'), retryLessonBtn: document.getElementById('retry-lesson-btn'), nextLessonBtn: document.getElementById('next-lesson-btn'), backToLessonsBtn: document.getElementById('back-to-lessons-btn'), homeBtn: document.getElementById('home-btn'), muteBtn: document.getElementById('mute-btn'), fullscreenBtn: document.getElementById('fullscreen-btn'), title: document.querySelector('h1'), infoBar: document.getElementById('info-bar'), countdownDisplay: document.getElementById('countdown-display'), bgm: document.getElementById('bgm'), leaderboardScreen: document.getElementById('leaderboard-screen'), leaderboardTitle: document.getElementById('leaderboard-title'), leaderboardList: document.getElementById('leaderboard-list'), leaderboardBackBtn: document.getElementById('leaderboard-back-btn'), btnLessonMode: document.getElementById('btn-lesson-mode'), btnEndless: document.getElementById('btn-endless'), btnChallenge: document.getElementById('btn-challenge'), comboDisplay: document.getElementById('combo-display'), achievementPopup: document.getElementById('achievement-popup'), achievementPopupTitle: document.getElementById('achievement-popup-title'), achievementPopupDesc: document.getElementById('achievement-popup-desc'), playerStats: document.getElementById('player-stats'), playerStatsMenu: document.getElementById('player-stats-menu'), btnShop: document.getElementById('btn-shop'), btnAchievements: document.getElementById('btn-achievements'), shopScreen: document.getElementById('shop-screen'), shopList: document.getElementById('shop-list'), shopBackBtn: document.getElementById('shop-back-btn'), achievementsScreen: document.getElementById('achievements-screen'), achievementList: document.getElementById('achievement-list'), achievementsBackBtn: document.getElementById('achievements-back-btn'), };
        
        let userProgress = {}, score, level, timeLeft, gameTimer, isMuted = false, draggedElement = null, isGameActive = false, currentGameMode = null, currentLesson = null, currentDifficulty = null, currentQuestion, correctAnswers, spawnerTimeout, currentPlayerName = '', comboCounter = 0, itemSpawner;
        const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const sounds = { correct: document.getElementById('sfx-correct'), wrong: document.getElementById('sfx-wrong'), combo: document.getElementById('sfx-combo'), countdown: document.getElementById('sfx-countdown'), levelup: document.getElementById('sfx-levelup'), achievement: document.getElementById('sfx-achievement'), powerup: document.getElementById('sfx-powerup'), bomb: document.getElementById('sfx-bomb'), end: document.getElementById('sfx-end') };
        
        const playSound = (key) => { if (!isMuted && sounds[key] && sounds[key].readyState >= 2) { sounds[key].currentTime = 0; sounds[key].play().catch(e => console.log(`Could not play sound ${key}:`, e)); } };
        const vibrate = (pattern) => { if (navigator.vibrate) navigator.vibrate(pattern); };
        const checkEvenOddAnswer = (number, grillId) => { const isEven = number % 2 === 0; const correctGrill = isEven ? 'grill-1' : 'grill-2'; return grillId === correctGrill; };

        function setupApplication() {
            dom.bgm.volume = 0.3;
            loadProgress();
            applyEquippedItems();
            dom.btnLessonMode.addEventListener('click', showLessonSelect);
            dom.btnEndless.addEventListener('click', () => startGame('endless'));
            dom.btnChallenge.addEventListener('click', showDifficultySelection);
            dom.btnEasy.addEventListener('click', () => startGame('challenge', 'easy'));
            dom.btnMedium.addEventListener('click', () => startGame('challenge', 'medium'));
            dom.btnHard.addEventListener('click', () => startGame('challenge', 'hard'));
            dom.homeBtn.addEventListener('click', showMainMenu);
            dom.muteBtn.addEventListener('click', toggleMute);
            dom.fullscreenBtn.addEventListener('click', toggleFullScreen);
            dom.backToLessonsBtn.addEventListener('click', showLessonSelect);
            dom.btnStartRegister.addEventListener('click', registerPlayer);
            dom.leaderboardBackBtn.addEventListener('click', showMainMenu);
            dom.btnShop.addEventListener('click', showShop);
            dom.btnAchievements.addEventListener('click', showAchievements);
            dom.shopBackBtn.addEventListener('click', showMainMenu);
            dom.achievementsBackBtn.addEventListener('click', showMainMenu);
            dom.lessonSelectBackBtn.addEventListener('click', showMainMenu);
            dom.difficultySelectBackBtn.addEventListener('click', showMainMenu);
            if (isTouchDevice) { initializeTouchEvents(); } else { initializeDragDrop(); }
            showRegisterScreen();
        }

        function initializeTouchEvents() {
            let originalSquid = null, draggedClone = null, offsetX = 0, offsetY = 0;
            const handleMove = (e) => {
                if (!draggedClone) return;
                e.preventDefault();
                const touch = e.touches[0];
                draggedClone.style.left = (touch.clientX - offsetX) + 'px';
                draggedClone.style.top = (touch.clientY - offsetY) + 'px';
                draggedClone.style.visibility = 'hidden';
                const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
                draggedClone.style.visibility = 'visible';
                [dom.grill1, dom.grill2].forEach(grill => { grill.classList.toggle('drag-over', grill === elementUnderTouch || grill.contains(elementUnderTouch)); });
            };
            const handleEnd = (e) => {
                if (!draggedClone) return;
                e.preventDefault();
                const touch = e.changedTouches[0];
                draggedClone.style.visibility = 'hidden';
                const elementUnderTouch = document.elementFromPoint(touch.clientX, touch.clientY);
                if (draggedClone.parentNode) { draggedClone.parentNode.removeChild(draggedClone); }
                [dom.grill1, dom.grill2].forEach(g => g.classList.remove('drag-over'));
                let droppedOnGrill = [dom.grill1, dom.grill2].find(g => g === elementUnderTouch || g.contains(elementUnderTouch));
                if (droppedOnGrill) {
                    if (originalSquid) {
                        originalSquid.style.visibility = 'visible';
                        const handler = (currentGameMode === 'lesson') ? handleAnswer : handlePracticeAnswer;
                        handler(originalSquid, droppedOnGrill.id, droppedOnGrill);
                    }
                } else {
                    if (originalSquid) {
                        if (currentGameMode === 'lesson') {
                            originalSquid.remove();
                        } else {
                            handlePracticeAnswer(originalSquid, 'none');
                        }
                    }
                }
                draggedClone = null; originalSquid = null;
            };
            dom.gameContainer.addEventListener('touchstart', (e) => {
                if (!isGameActive) return;
                const target = e.target.closest('.squid');
                if (!target || target.classList.contains('squid-correct') || target.classList.contains('squid-wrong')) return;
                e.preventDefault();
                originalSquid = target; originalSquid.style.animation = 'none';
                draggedClone = originalSquid.cloneNode(true);
                draggedClone.style.transition = 'none'; draggedClone.classList.add('dragging');
                originalSquid.style.visibility = 'hidden';
                const rect = originalSquid.getBoundingClientRect();
                const touch = e.touches[0];
                offsetX = touch.clientX - rect.left; offsetY = touch.clientY - rect.top;
                document.body.appendChild(draggedClone);
                draggedClone.style.position = 'absolute'; draggedClone.style.zIndex = '1000';
                handleMove(e);
            }, { passive: false });
            dom.gameContainer.addEventListener('touchmove', handleMove, { passive: false });
            dom.gameContainer.addEventListener('touchend', handleEnd);
        }

        function initializeDragDrop() { 
            [dom.grill1, dom.grill2].forEach(grill => { 
                grill.addEventListener('dragover', e => { e.preventDefault(); if(isGameActive) grill.classList.add('drag-over'); }); 
                grill.addEventListener('dragleave', () => grill.classList.remove('drag-over')); 
                grill.addEventListener('drop', e => { 
                    e.preventDefault(); if (!draggedElement || !isGameActive) return; 
                    grill.classList.remove('drag-over'); 
                    const handler = (currentGameMode === 'lesson') ? handleAnswer : handlePracticeAnswer; 
                    handler(draggedElement, e.currentTarget.id, e.currentTarget); 
                    draggedElement = null; 
                }); 
            }); 
        }

        function loadProgress() {
            const saved = localStorage.getItem('squid_cai_progress_p2');
            const defaultProgress = { unlockedLessons: ['L01'], highScores: {}, coins: 0, unlockedAchievements: [], ownedItems: { colors: ['color_default'] }, equippedItems: { color: 'color_default' } };
            userProgress = saved ? { ...defaultProgress, ...JSON.parse(saved) } : defaultProgress;
        }

        function saveProgress() { localStorage.setItem('squid_cai_progress_p2', JSON.stringify(userProgress)); }
        function showRegisterScreen() { dom.playerNameInput.value = ''; showScreen('register-screen'); dom.playerNameInput.focus(); }
        
        function registerPlayer() { 
            const name = dom.playerNameInput.value.trim(); 
            if (name === '') { alert('กรุณาใส่ชื่อของคุณ!'); return; } 
            currentPlayerName = name; 
            if (!isMuted) dom.bgm.play().catch(()=>{}); 
            showMainMenu(); 
        }
        
        function showMainMenu() { 
            showScreen('main-menu-screen'); 
            updatePlayerStats(); 
            dom.title.textContent = ``; 
            dom.infoBar.innerHTML = ''; 
            dom.feedback.innerHTML = 'เลือกโหมดที่ต้องการเล่นได้เลย!'; 
            dom.grill1Label.textContent = ''; dom.grill2Label.textContent = ''; 
            dom.homeBtn.style.display = 'none'; 
        }
        
        function showScreen(screenId) { 
            document.querySelectorAll('.screen-overlay').forEach(s => s.classList.remove('active')); 
            if (screenId) document.getElementById(screenId).classList.add('active'); 
            const isGameScreen = !screenId; 
            dom.homeBtn.style.display = isGameScreen ? 'flex' : 'none'; 
            isGameActive = false; 
            clearTimeout(spawnerTimeout); 
            clearInterval(gameTimer); 
            clearInterval(itemSpawner); 
            dom.squidArea.innerHTML = ''; 
        }
        
        function updatePlayerStats() { const statsHTML = `ผู้เล่น: ${currentPlayerName} | 💰 ${userProgress.coins}`; dom.playerStats.innerHTML = statsHTML; dom.playerStatsMenu.innerHTML = statsHTML; }
        
        const toggleMute = () => { isMuted = !isMuted; dom.muteBtn.classList.toggle('muted', isMuted); dom.bgm.muted = isMuted; if (!isMuted) dom.bgm.play().catch(()=>{}); };
        const toggleFullScreen = () => { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(() => {}); } else if (document.exitFullscreen) { document.exitFullscreen(); } };
        document.addEventListener('fullscreenchange', () => { const isFullscreen = !!document.fullscreenElement; dom.fullscreenBtn.classList.toggle('fs-exit', isFullscreen); });
        
        function startGame(mode, difficulty = 'medium') {
            currentGameMode = mode; currentDifficulty = difficulty;
            score = 0; comboCounter = 0; timeLeft = 0;
            if (itemSpawner) clearInterval(itemSpawner);
            showScreen(null);
            dom.feedback.innerHTML = '';
            startCountdown(() => {
                isGameActive = true;
                if (mode === 'lesson') playLesson();
                else if (mode === 'endless') setupEndlessMode();
                else if (mode === 'challenge') setupChallengeMode();
                if (mode !== 'lesson') { itemSpawner = setInterval(spawnRandomItem, CONFIG.itemSpawnInterval); }
            });
        }
        
        function startCountdown(onComplete) {
            let count = 3;
            dom.countdownDisplay.style.display = 'block';

            const updateAndShow = () => {
                dom.countdownDisplay.classList.remove('countdown-pop');
                void dom.countdownDisplay.offsetWidth; 

                if (count > 0) {
                    dom.countdownDisplay.textContent = count;
                    playSound('countdown');
                } else {
                    dom.countdownDisplay.textContent = 'GO!';
                    playSound('levelup');
                }
                dom.countdownDisplay.classList.add('countdown-pop');
            };

            const countdownInterval = setInterval(() => {
                count--;
                if (count < -1) { 
                    clearInterval(countdownInterval);
                    dom.countdownDisplay.style.display = 'none';
                    onComplete();
                } else if (count >= 0) {
                    updateAndShow();
                } else {
                    dom.countdownDisplay.style.display = 'none';
                }
            }, 1000);

            updateAndShow();
        }

        function endGame() {
            playSound('end'); // Play sound on game over
            isGameActive = false; clearTimeout(spawnerTimeout); clearInterval(gameTimer); clearInterval(itemSpawner);
            dom.squidArea.innerHTML = '';
            const coinsEarned = Math.floor(score / 2);
            if (coinsEarned > 0) { userProgress.coins += coinsEarned; }
            const modeKey = currentGameMode + (currentGameMode === 'challenge' ? `_${currentDifficulty}` : '');
            if (currentGameMode !== 'lesson') {
                const highScoreKey = `highScore_${modeKey}`;
                if (!userProgress.highScores) userProgress.highScores = {};
                const currentHighScore = userProgress.highScores[highScoreKey] || 0;
                if (score > currentHighScore) { userProgress.highScores[highScoreKey] = score; }
                saveProgress();
                saveScoreToLeaderboard(modeKey, currentPlayerName, score);
                displayLeaderboard(modeKey);
            } else { showLessonComplete(); }
        }

        function createSquid(number, options = {}) {
            const { position = {}, animationClasses = 'spawn-anim', animationDuration } = options;
            const squidEl = document.createElement('div');
            
            let classList = 'squid ';
            const isAbsolute = animationClasses.includes('squid-rise');
            
            if(isAbsolute) {
                classList += 'squid-absolute ';
            } else if (currentGameMode === 'endless') {
                classList += 'endless-squid ';
            }
            
            classList += animationClasses;
            squidEl.className = classList;

            squidEl.dataset.number = number;
            squidEl.innerHTML = `<span class="number-display">${number}</span>`;
            const squidType = Math.floor(Math.random() * 8) + 1;
            squidEl.style.backgroundImage = `url('squid-${squidType}.png')`;
            
            if (currentGameMode !== 'endless' && currentGameMode !== 'challenge') {
                 dom.squidArea.innerHTML = '';
            }
            dom.squidArea.appendChild(squidEl);
            Object.assign(squidEl.style, position);

            if (!isTouchDevice) {
                squidEl.draggable = true;
                squidEl.addEventListener('dragstart', (e) => { 
                    draggedElement = e.target.closest('.squid'); 
                    if (draggedElement) {
                        setTimeout(() => draggedElement.classList.add('dragging'), 0)
                    }; 
                });
                squidEl.addEventListener('dragend', () => { 
                    if (draggedElement) { 
                        draggedElement.classList.remove('dragging');
                    }
                });
            }

            if (animationClasses.includes('squid-rise')) {
                squidEl.style.animationDuration = `${animationDuration}s`;
                squidEl.addEventListener('animationend', () => { if (squidEl.parentElement) { handlePracticeAnswer(squidEl, 'none'); } });
            }
        }

        function handleAnswer(squidEl, grillId, grillEl) {
            if (!isGameActive) return;
            isGameActive = false; 
            const num = parseInt(squidEl.dataset.number);
            const isCorrect = checkEvenOddAnswer(num, grillId);
            
            squidEl.draggable = false;
            squidEl.style.pointerEvents = 'none';

            if (isCorrect) {
                correctAnswers++;
                playSound('correct');
                vibrate(100);
                
                const grillRect = grillEl.getBoundingClientRect();
                const containerRect = dom.gameContainer.getBoundingClientRect();
                squidEl.style.top = `${grillRect.top - containerRect.top}px`;
                squidEl.style.left = `${grillRect.left - containerRect.left}px`;
                squidEl.style.width = `${grillRect.width}px`;
                squidEl.style.height = `${grillRect.height}px`;

                squidEl.classList.add('squid-correct');
            } else {
                playSound('wrong');
                vibrate([100, 50, 100]);
                squidEl.classList.add('squid-wrong');
            }

            dom.feedback.innerHTML = currentLesson.getExplanation(num, isCorrect);
            updateHUD();

            const delay = isCorrect ? 2000 : 500; 
            setTimeout(() => {
                squidEl.remove();
                isGameActive = true;
                nextQuestion();
            }, delay);
        }

        function handlePracticeAnswer(squidEl, grillId, grillEl = null) {
            if (!squidEl || !squidEl.parentElement) return; 

            squidEl.style.pointerEvents = 'none';
            squidEl.draggable = false;
            squidEl.style.animationPlayState = 'paused'; 

            const num = parseInt(squidEl.dataset.number);
            const isCorrect = (grillId !== 'none') && checkEvenOddAnswer(num, grillId);
            
            let animationDelay;

            if (isCorrect) {
                animationDelay = 2000;
                let currentBonus = 0;
                comboCounter++;
                if (comboCounter >= CONFIG.comboThreshold) {
                    currentBonus = CONFIG.comboBonusScore;
                    showCombo(comboCounter);
                }
                score += (1 + currentBonus);
                playSound('correct');
                vibrate(100);
                const scoreContainer = dom.infoBar.querySelector('#score-container');
                if (scoreContainer) { scoreContainer.classList.add('score-pop'); setTimeout(() => scoreContainer.classList.remove('score-pop'), 300); }
                
                const grillRect = grillEl.getBoundingClientRect();
                const containerRect = dom.gameContainer.getBoundingClientRect();
                squidEl.style.top = `${grillRect.top - containerRect.top}px`;
                squidEl.style.left = `${grillRect.left - containerRect.left}px`;
                squidEl.style.width = `${grillRect.width}px`;
                squidEl.style.height = `${grillRect.height}px`;

                squidEl.classList.add('squid-correct');
                squidEl.style.animationPlayState = 'running';

                checkAchievement('combo', comboCounter);
                if (currentGameMode === 'endless' && level < 10 && score >= level * CONFIG.practice.endless.levelUpScore) { 
                    level++; 
                    timeLeft += CONFIG.practice.endless.timeBonus; 
                    playSound('levelup'); 
                }
            } else {
                animationDelay = 500;
                comboCounter = 0;
                playSound('wrong');
                vibrate([100, 50, 100]);
                squidEl.classList.add('squid-wrong');
                squidEl.style.animationPlayState = 'running';
            }

            updateHUD();
            checkAchievement('score_endless', score);
            
            setTimeout(() => {
                if (squidEl) squidEl.remove();
                if (isGameActive && currentGameMode === 'endless' && isCorrect) {
                    generateSquidEndless();
                }
            }, animationDelay);
        }

        
        function updateHUD() {
            let titleText = ''; let infoHTML = '';
            if (currentGameMode === 'lesson') {
                titleText = currentLesson.title;
                infoHTML = `<div>ข้อที่: ${currentQuestion}/${currentLesson.questionsTotal}</div> <div>ถูกต้อง: ${correctAnswers}</div>`;
            } else {
                const modeConfig = CONFIG.practice[currentGameMode];
                const diffName = currentGameMode === 'challenge' ? ` (${modeConfig.difficulties[currentDifficulty].name})` : '';
                titleText = `${currentPlayerName} | ${modeConfig.title}${diffName}`;
                let highScoreKey = `highScore_${currentGameMode}` + (currentGameMode === 'challenge' ? `_${currentDifficulty}` : '');
                let highScore = userProgress.highScores[highScoreKey] || 0;
                infoHTML = `<div id="score-container">คะแนน: <span id="score">${score}</span></div> <div id="hiscore-container">สูงสุด: ${highScore}</div> <div id="timer-board">เวลา: <span id="timer">${timeLeft}</span></div>`;
            }
            dom.title.textContent = titleText;
            dom.infoBar.innerHTML = infoHTML;
        }

        function showLessonSelect() {
            dom.lessonSelectTitle.textContent = "เลือกบทเรียน"; const list = dom.lessonList; list.innerHTML = '';
            CONFIG.lessons.forEach(lesson => {
                const isUnlocked = userProgress.unlockedLessons.includes(lesson.id);
                const li = document.createElement('li');
                li.className = `lesson-item ${isUnlocked ? '' : 'locked'}`;
                li.innerHTML = `${lesson.title} <span class="lock-icon">🔒</span>`;
                if (isUnlocked) li.addEventListener('click', () => { currentLesson = lesson; showTutorial(); });
                list.appendChild(li);
            });
            showScreen('lesson-select-screen');
        }

        function showDifficultySelection() { showScreen('difficulty-selection-screen'); }
        function showTutorial() { dom.tutorialTitle.textContent = currentLesson.title; dom.tutorialBody.innerHTML = currentLesson.tutorialHTML; dom.startLessonBtn.onclick = () => startGame('lesson'); showScreen('tutorial-screen'); }
        
        function playLesson() { currentQuestion = 0; correctAnswers = 0; dom.grill1Label.textContent = currentLesson.grillLabels.one; dom.grill2Label.textContent = currentLesson.grillLabels.two; nextQuestion(); }
        function nextQuestion() { 
            if (!isGameActive) return; 
            if (currentQuestion >= currentLesson.questionsTotal) { 
                isGameActive = false; 
                setTimeout(endGame, 500); 
                return; 
            } 
            currentQuestion++; 
            updateHUD(); 
            dom.feedback.innerHTML = ''; 
            createSquid(currentLesson.problemGenerator()); 
        }
        
        function setupEndlessMode() { score = 0; level = 1; timeLeft = CONFIG.practice.endless.initialTime; dom.grill1Label.textContent = "เลขคู่"; dom.grill2Label.textContent = "เลขคี่"; updateHUD(); generateSquidEndless(); gameTimer = setInterval(updateTimer, 1000); }
        
        function generateSquidEndless() {
            const oldSquid = dom.squidArea.querySelector('.endless-squid');
            if (oldSquid) {
                oldSquid.remove();
            }
            const number = Math.floor(Math.random() * (20 * Math.pow(level, 2))) + 1;
            createSquid(number);
        }

        const updateTimer = () => { timeLeft--; updateHUD(); if (timeLeft <= 0) { timeLeft = 0; updateHUD(); endGame(); } };
        function setupChallengeMode() { score = 0; timeLeft = CONFIG.practice.challenge.duration; dom.grill1Label.textContent = "เลขคู่"; dom.grill2Label.textContent = "เลขคี่"; updateHUD(); scheduleNextSquid(); gameTimer = setInterval(updateTimer, 1000); }
        function scheduleNextSquid() { if (!isGameActive || timeLeft <= 0) return; const { minSpawn, maxSpawn } = CONFIG.practice.challenge.difficulties[currentDifficulty]; const nextSpawnTime = Math.random() * (maxSpawn - minSpawn) + minSpawn; spawnerTimeout = setTimeout(() => { spawnSquidChallenge(); scheduleNextSquid(); }, nextSpawnTime); }
        
        function spawnSquidChallenge() {
            if (!isGameActive) return;
            const { numLanes, horizontalMargin, difficulties } = CONFIG.practice.challenge;
            const difficultySettings = difficulties[currentDifficulty];

            const effectiveWidth = 100 - (horizontalMargin * 2);
            const laneWidth = effectiveWidth / numLanes;
            
            const occupiedLanes = Array.from(dom.squidArea.querySelectorAll('.squid-absolute')).map(squid => {
                const leftPercent = parseFloat(squid.style.left);
                return Math.floor((leftPercent - horizontalMargin) / laneWidth);
            });
            
            let availableLanes = Array.from({ length: numLanes }, (_, i) => i).filter(lane => !occupiedLanes.includes(lane));
            if (availableLanes.length === 0) return;

            const chosenLane = availableLanes[Math.floor(Math.random() * availableLanes.length)];
            const positionX = horizontalMargin + (chosenLane * laneWidth) + (laneWidth / 2);
            
            const speed = Math.random() * (difficultySettings.maxSpeed - difficultySettings.minSpeed) + difficultySettings.minSpeed;

            createSquid(Math.floor(Math.random() * 1000) + 1, {
                position: { left: `${positionX}%` }, 
                animationClasses: 'squid-rise',
                animationDuration: speed
            });
        }
        
        function showLessonComplete() {
            const accuracy = (correctAnswers / currentLesson.questionsTotal) * 100;
            const passed = accuracy >= (currentLesson.passThreshold / currentLesson.questionsTotal * 100);
            dom.summaryTitle.textContent = passed ? "ยินดีด้วย คุณผ่านแล้ว!" : "พยายามอีกนิดนะ!";
            dom.summaryAccuracy.textContent = `ความแม่นยำ: ${accuracy.toFixed(0)}% (ตอบถูก ${correctAnswers} จาก ${currentLesson.questionsTotal} ข้อ)`;
            dom.summaryStars.textContent = passed ? (accuracy >= 95 ? '⭐⭐⭐' : (accuracy >= 80 ? '⭐⭐' : '⭐')) : '';
            dom.summaryFeedback.textContent = passed ? "ไปต่อบทเรียนถัดไปได้เลย!" : "ลองทบทวนอีกครั้งนะ";
            if (passed) { unlockNextLesson(currentLesson.id); saveProgress(); checkAchievement('lesson1_passed'); }
            dom.retryLessonBtn.onclick = () => { currentLesson = CONFIG.lessons.find(l => l.id === currentLesson.id); startGame('lesson'); };
            const nextLessonIndex = CONFIG.lessons.findIndex(l => l.id === currentLesson.id) + 1;
            const hasNextLesson = nextLessonIndex < CONFIG.lessons.length;
            dom.nextLessonBtn.style.display = (passed && hasNextLesson) ? 'inline-block' : 'none';
            if (passed && hasNextLesson) { dom.nextLessonBtn.onclick = () => { currentLesson = CONFIG.lessons[nextLessonIndex]; showTutorial(); }; }
            showScreen('lesson-complete-screen');
        }
        function unlockNextLesson(lessonId) { const nextIdx = CONFIG.lessons.findIndex(l=>l.id===lessonId) + 1; if(nextIdx < CONFIG.lessons.length){ const nextLessonId = CONFIG.lessons[nextIdx].id; if(!userProgress.unlockedLessons.includes(nextLessonId)) userProgress.unlockedLessons.push(nextLessonId);}}

        function getLeaderboard(modeKey) { try { return JSON.parse(localStorage.getItem(`leaderboard_${modeKey}`)) || []; } catch (e) { return []; } }
        function saveScoreToLeaderboard(modeKey, name, score) { if (!modeKey || modeKey === 'lesson') return; const lb = getLeaderboard(modeKey); lb.push({ name, score, date: new Date().toLocaleString() }); lb.sort((a, b) => b.score - a.score); localStorage.setItem(`leaderboard_${modeKey}`, JSON.stringify(lb.slice(0, 10))); }
        function displayLeaderboard(modeKey) { const lb = getLeaderboard(modeKey); dom.leaderboardTitle.textContent = `คะแนนสูงสุด: ${CONFIG.practice[currentGameMode].title}` + (currentGameMode === 'challenge' ? ` (${CONFIG.practice.challenge.difficulties[currentDifficulty].name})` : ''); dom.leaderboardList.innerHTML = lb.length === 0 ? '<li>ยังไม่มีคะแนน</li>' : lb.map((e, i) => `<li><span class="rank">${i+1}.</span><span class="name">${e.name}</span><span class="score">${e.score}</span></li>`).join(''); showScreen('leaderboard-screen'); }
        
        function showCombo(count) { playSound('combo'); dom.comboDisplay.textContent = `${count} COMBO!`; dom.comboDisplay.style.animation = 'none'; dom.comboDisplay.offsetHeight; dom.comboDisplay.style.animation = 'combo-pop 0.8s ease-out'; }
        
        function spawnRandomItem() {
            if (!isGameActive) return;
            const areaRect = dom.squidArea.getBoundingClientRect();
            if (areaRect.width === 0) return;

            const itemEl = document.createElement('div');
            itemEl.className = 'game-item';

            const isBomb = Math.random() < 0.5;
            if (isBomb) {
                itemEl.classList.add('item-bomb');
                itemEl.onclick = () => { playSound('bomb'); score = Math.max(0, score - 10); updateHUD(); itemEl.classList.add('item-clicked'); setTimeout(() => itemEl.remove(), 400); };
            } else {
                itemEl.classList.add('item-timer');
                itemEl.onclick = () => { playSound('powerup'); timeLeft += 5; updateHUD(); itemEl.classList.add('item-clicked'); setTimeout(() => itemEl.remove(), 400); };
            }
            
            dom.squidArea.appendChild(itemEl);
            
            const itemWidth = itemEl.offsetWidth;

            itemEl.style.left = Math.random() * (areaRect.width - itemWidth) + 'px';
            itemEl.style.top = `-${itemWidth}px`;
            itemEl.style.animationDuration = `${CONFIG.itemFallDuration / 1000}s`;


            setTimeout(() => {
                if (itemEl.parentElement) itemEl.remove();
            }, CONFIG.itemFallDuration);
        }

        function checkAchievement(trigger, value) {
            let achId = null;
            if (trigger === 'lesson1_passed') achId = 'ach_lesson1_passed';
            if (trigger === 'score_endless' && value >= 50) achId = 'ach_score_50_endless';
            if (trigger === 'combo' && value >= 5) achId = 'ach_combo_5';
            if (trigger === 'shop_buy') achId = 'ach_shop_first_buy';
            if (achId && !userProgress.unlockedAchievements.includes(achId)) { unlockAchievement(achId); }
        }

        function unlockAchievement(achId) {
            const achData = CONFIG.achievements.find(a => a.id === achId);
            if (!achData) return;
            userProgress.unlockedAchievements.push(achId); saveProgress();
            playSound('achievement');
            dom.achievementPopupTitle.textContent = 'ปลดล็อกรางวัล!';
            dom.achievementPopupDesc.textContent = achData.title;
            dom.achievementPopup.style.display = 'block';
            setTimeout(() => { dom.achievementPopup.style.display = 'none'; }, 4000);
        }

        function showAchievements() {
            dom.achievementList.innerHTML = '';
            CONFIG.achievements.forEach(ach => {
                const isUnlocked = userProgress.unlockedAchievements.includes(ach.id);
                const li = document.createElement('li');
                li.className = `achievement-item ${isUnlocked ? 'unlocked' : ''}`;
                li.innerHTML = `<h4>${ach.title}</h4><p>${ach.description}</p>`;
                dom.achievementList.appendChild(li);
            });
            showScreen('achievements-screen');
        }

        function showShop() {
            dom.shopList.innerHTML = '';
            CONFIG.shop.colors.forEach(item => {
                const isOwned = userProgress.ownedItems.colors.includes(item.id);
                const isEquipped = userProgress.equippedItems.color === item.id;
                const itemEl = document.createElement('div');
                itemEl.className = 'shop-item';
                if (isOwned) itemEl.classList.add('owned');
                if (isEquipped) itemEl.classList.add('equipped');
                itemEl.innerHTML = `<div class="item-preview" style="filter: ${item.filter};"></div><div>${item.name}</div><div class="item-price">${isOwned ? (isEquipped ? 'ใช้งานอยู่' : 'มีแล้ว') : `💰 ${item.price}`}</div>`;
                if (!isOwned) { itemEl.onclick = () => buyItem('colors', item); } 
                else if (!isEquipped) { itemEl.onclick = () => equipItem('color', item); }
                dom.shopList.appendChild(itemEl);
            });
            showScreen('shop-screen');
        }

        function buyItem(category, item) {
            if (userProgress.coins >= item.price) {
                userProgress.coins -= item.price;
                userProgress.ownedItems[category].push(item.id);
                updatePlayerStats(); saveProgress();
                checkAchievement('shop_buy');
                showShop();
            } else { alert('เหรียญไม่พอ!'); }
        }

        function equipItem(category, item) {
            userProgress.equippedItems[category] = item.id;
            saveProgress(); applyEquippedItems(); showShop();
        }

        function applyEquippedItems() {
            const equippedColorId = userProgress.equippedItems.color;
            const equippedColor = CONFIG.shop.colors.find(c => c.id === equippedColorId);
            if (equippedColor) { document.documentElement.style.setProperty('--squid-color-filter', equippedColor.filter); }
        }

        const baseImages = ['BG.png', 'grill-1.png', 'grill-2.png', 'time.png', 'bomb.png'];
        const squidImages = [];
        for (let i = 1; i <= 8; i++) { squidImages.push(`squid-${i}.png`); }
        const imagesToLoad = [...baseImages, ...squidImages];
        let imagesLoaded = 0;
        
        function preloader() {
            if (imagesToLoad.length === 0) {
                return gameReady();
            }
            imagesToLoad.forEach(src => {
                const img = new Image(); img.src = src;
                const processLoad = () => { imagesLoaded++; if (imagesLoaded === imagesToLoad.length) { gameReady(); } };
                img.onload = processLoad;
                img.onerror = () => { console.error(`Cannot load image: ${src}`); processLoad(); };
            });
        }

        function gameReady() {
            const loadingScreen = document.getElementById('loading-screen');
            const gameContainer = document.getElementById('game-container');
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (gameContainer) gameContainer.style.visibility = 'visible';
            setTimeout(() => {
                if (dom.welcomeCreditScreen) dom.welcomeCreditScreen.style.display = 'none';
                setupApplication();
            }, 4000);
        }

        preloader();
    });
    </script>
</body>
</html>